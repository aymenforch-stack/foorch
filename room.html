<!DOCTYPE html>
<html>
<head>
    <title>ğŸ¥ ØºØ±ÙØ© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: Arial;
            margin: 0;
            padding: 10px;
            background: #1a1a2e;
            color: white;
        }
        
        #roomHeader {
            background: #16213e;
            padding: 15px;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        #roomId {
            font-size: 1.5em;
            color: #4ecca3;
            font-weight: bold;
        }
        
        .video-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }
        
        video {
            width: 100%;
            max-width: 600px;
            background: black;
            border-radius: 10px;
            border: 3px solid #4ecca3;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        .control-btn {
            background: #232931;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 50px;
            font-size: 16px;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-width: 150px;
        }
        
        .control-btn:hover {
            transform: scale(1.05);
        }
        
        .btn-share { background: #4ecca3; }
        .btn-control { background: #f95959; }
        .btn-audio { background: #233142; }
        .btn-end { background: #ff9a3c; }
        
        #status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .hidden { display: none; }
    </style>
</head>
<body>
    <div id="roomHeader">
        <h2>ğŸ¥ ØºØ±ÙØ© Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø©</h2>
        <div>ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©: <span id="roomId">...</span></div>
    </div>

    <div id="status">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</div>

    <div class="video-container">
        <video id="localVideo" autoplay muted playsinline></video>
        <video id="remoteVideo" autoplay playsinline></video>
    </div>

    <div class="controls">
        <button class="control-btn btn-share" onclick="shareScreen()">
            ğŸ–¥ï¸ Ù…Ø´Ø§Ø±ÙƒØ© Ø´Ø§Ø´ØªÙŠ
        </button>
        
        <button class="control-btn btn-control" onclick="requestControl()">
            ğŸ® Ø§Ù„ØªØ­ÙƒÙ… Ø¹Ù† Ø¨Ø¹Ø¯
        </button>
        
        <button class="control-btn btn-audio" onclick="toggleAudio()">
            ğŸ”Š ÙƒØªÙ… Ø§Ù„ØµÙˆØª
        </button>
        
        <button class="control-btn btn-end" onclick="endSession()">
            âŒ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©
        </button>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø·Ù„Ø¨ Ø§Ù„ØªØ­ÙƒÙ… -->
    <div id="controlModal" class="hidden" style="
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        color: black;
        padding: 30px;
        border-radius: 15px;
        text-align: center;
        z-index: 1000;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    ">
        <h3>ğŸ® Ø·Ù„Ø¨ ØªØ­ÙƒÙ… Ø¹Ù† Ø¨Ø¹Ø¯</h3>
        <p id="controlRequester">...</p>
        <p>Ø³ÙŠØªÙ…ÙƒÙ† Ù…Ù† ØªØ­Ø±ÙŠÙƒ Ø§Ù„ÙØ£Ø±Ø© ÙˆØ§Ù„Ù†Ù‚Ø± ÙˆØ§Ù„ÙƒØªØ§Ø¨Ø©</p>
        <div style="margin-top: 20px;">
            <button onclick="acceptControl()" style="
                background: #4CAF50;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                cursor: pointer;
                margin: 5px;
            ">âœ… Ø£ÙˆØ§ÙÙ‚</button>
            <button onclick="rejectControl()" style="
                background: #f44336;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                cursor: pointer;
                margin: 5px;
            ">âŒ Ø£Ø±ÙØ¶</button>
        </div>
    </div>

    <script>
        // Ù…ØªØºÙŠØ±Ø§Øª
        let peerConnection = null;
        let localStream = null;
        let roomId = null;
        let socket = null;
        let isSharing = false;
        let isAudioMuted = false;
        let hasControl = false;
        let partnerId = null;

        // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.onload = function() {
            roomId = new URLSearchParams(window.location.search).get('room') || 'TEST';
            document.getElementById('roomId').textContent = roomId;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
            document.title = `ØºØ±ÙØ© ${roomId} - Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø©`;
            
            // Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…
            connectToServer();
        };

        // Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø§Ø¯Ù… WebSocket Ø§Ù„Ø®Ø§Øµ Ø¨Ù†Ø§
        function connectToServer() {
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${window.location.host}/ws?room=${roomId}`;
            
            socket = new WebSocket(wsUrl);
            
            socket.onopen = () => {
                updateStatus('âœ… Ù…ØªØµÙ„ - Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©');
            };
            
            socket.onmessage = (event) => {
                const message = JSON.parse(event.data);
                handleMessage(message);
            };
            
            socket.onclose = () => {
                updateStatus('âŒ Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„');
            };
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        function handleMessage(msg) {
            switch(msg.type) {
                case 'user-joined':
                    partnerId = msg.userId;
                    updateStatus(`ğŸ‘¤ ${msg.userId} Ø§Ù†Ø¶Ù… Ù„Ù„ØºØ±ÙØ©`);
                    break;
                    
                case 'offer':
                    handleOffer(msg);
                    break;
                    
                case 'answer':
                    handleAnswer(msg);
                    break;
                    
                case 'ice-candidate':
                    handleIceCandidate(msg);
                    break;
                    
                case 'control-request':
                    showControlRequest(msg.from);
                    break;
                    
                case 'control-response':
                    if (msg.accepted) {
                        hasControl = true;
                        updateStatus('âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨ Ø§Ù„ØªØ­ÙƒÙ…');
                        startSendingInputEvents();
                    } else {
                        updateStatus('âŒ ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨ Ø§Ù„ØªØ­ÙƒÙ…');
                    }
                    break;
            }
        }

        // Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø©
        async function shareScreen() {
            try {
                const stream = await navigator.mediaDevices.getDisplayMedia({
                    video: { cursor: "always" },
                    audio: true
                });
                
                localStream = stream;
                document.getElementById('localVideo').srcObject = stream;
                
                isSharing = true;
                updateStatus('âœ… ØªÙ… Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø©');
                
                // Ø¥Ø¹Ø¯Ø§Ø¯ WebRTC Ù…Ø¹ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±
                setupWebRTC(stream);
                
            } catch (error) {
                updateStatus('âŒ ÙØ´Ù„ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø©');
                console.error(error);
            }
        }

        // Ø¥Ø¹Ø¯Ø§Ø¯ WebRTC
        function setupWebRTC(stream) {
            const config = {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            };
            
            peerConnection = new RTCPeerConnection(config);
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø­Ù„ÙŠ
            stream.getTracks().forEach(track => {
                peerConnection.addTrack(track, stream);
            });
            
            // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø¨Ø« Ù…Ù† Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±
            peerConnection.ontrack = (event) => {
                document.getElementById('remoteVideo').srcObject = event.streams[0];
                updateStatus('ğŸ“º ØªØ³ØªÙ‚Ø¨Ù„ Ø´Ø§Ø´Ø© Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±');
            };
            
            // Ø¥Ø±Ø³Ø§Ù„ ICE Candidates
            peerConnection.onicecandidate = (event) => {
                if (event.candidate && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({
                        type: 'ice-candidate',
                        candidate: event.candidate
                    }));
                }
            };
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø±Ø¶
            peerConnection.createOffer()
                .then(offer => peerConnection.setLocalDescription(offer))
                .then(() => {
                    socket.send(JSON.stringify({
                        type: 'offer',
                        sdp: peerConnection.localDescription
                    }));
                });
        }

        // Ø·Ù„Ø¨ Ø§Ù„ØªØ­ÙƒÙ… Ø¹Ù† Ø¨Ø¹Ø¯
        function requestControl() {
            if (!partnerId) {
                updateStatus('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ø±Ù Ø¢Ø®Ø± ÙÙŠ Ø§Ù„ØºØ±ÙØ©');
                return;
            }
            
            socket.send(JSON.stringify({
                type: 'control-request',
                to: partnerId
            }));
            
            updateStatus('ğŸ“¤ Ø£Ø±Ø³Ù„Øª Ø·Ù„Ø¨ ØªØ­ÙƒÙ…...');
        }

        // Ø¹Ø±Ø¶ Ø·Ù„Ø¨ Ø§Ù„ØªØ­ÙƒÙ… Ù„Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±
        function showControlRequest(from) {
            document.getElementById('controlRequester').textContent = 
                `${from} ÙŠØ±ÙŠØ¯ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø´Ø§Ø´ØªÙƒ`;
            document.getElementById('controlModal').classList.remove('hidden');
        }

        // Ù‚Ø¨ÙˆÙ„ Ø§Ù„ØªØ­ÙƒÙ…
        function acceptControl() {
            socket.send(JSON.stringify({
                type: 'control-response',
                to: partnerId,
                accepted: true
            }));
            
            document.getElementById('controlModal').classList.add('hidden');
            updateStatus('âœ… Ø³Ù…Ø­Øª Ø¨Ø§Ù„ØªØ­ÙƒÙ… Ø¹Ù† Ø¨Ø¹Ø¯');
        }

        // Ø±ÙØ¶ Ø§Ù„ØªØ­ÙƒÙ…
        function rejectControl() {
            socket.send(JSON.stringify({
                type: 'control-response',
                to: partnerId,
                accepted: false
            }));
            
            document.getElementById('controlModal').classList.add('hidden');
            updateStatus('âŒ Ø±ÙØ¶Øª Ø§Ù„ØªØ­ÙƒÙ… Ø¹Ù† Ø¨Ø¹Ø¯');
        }

        // Ø¨Ø¯Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØªØ­ÙƒÙ…
        function startSendingInputEvents() {
            // Ù‡Ù†Ø§ ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ø§ÙˆØ³ ÙˆØ§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯
            // ØªÙ†ÙÙŠØ° Ø­Ù‚ÙŠÙ‚ÙŠ ÙŠØªØ·Ù„Ø¨ Ø³Ù…Ø§Ø­ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            updateStatus('ğŸ® Ø¬Ø§Ù‡Ø² Ù„Ø¥Ø±Ø³Ø§Ù„ Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªØ­ÙƒÙ…');
        }

        // ØªØ¨Ø¯ÙŠÙ„ ÙƒØªÙ… Ø§Ù„ØµÙˆØª
        function toggleAudio() {
            if (localStream) {
                localStream.getAudioTracks().forEach(track => {
                    track.enabled = !track.enabled;
                });
                isAudioMuted = !isAudioMuted;
                updateStatus(isAudioMuted ? 'ğŸ”‡ ÙƒØªÙ…Øª Ø§Ù„ØµÙˆØª' : 'ğŸ”Š Ø£Ù„ØºÙŠØª ÙƒØªÙ… Ø§Ù„ØµÙˆØª');
            }
        }

        // Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©
        function endSession() {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©ØŸ')) {
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                }
                if (peerConnection) {
                    peerConnection.close();
                }
                if (socket) {
                    socket.close();
                }
                window.location.href = '/';
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        // Ø¯Ø¹Ù… Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©
        if ('ontouchstart' in window) {
            document.querySelectorAll('button').forEach(btn => {
                btn.style.padding = '20px 30px';
                btn.style.fontSize = '18px';
            });
        }
    </script>
</body>
</html>